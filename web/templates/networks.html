<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-shield-lock me-2"></i>OpenVPN Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/users">
                            <i class="bi bi-people me-1"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/groups">
                            <i class="bi bi-diagram-3 me-1"></i>Groups
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/networks">
                            <i class="bi bi-hdd-network me-1"></i>Networks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/audit">
                            <i class="bi bi-journal-text me-1"></i>Audit
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sessions">
                            <i class="bi bi-clock-history me-1"></i>History
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>Profile
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="bi bi-hdd-network me-2"></i>Networks</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNetworkModal">
                        <i class="bi bi-plus-lg me-1"></i>Create Network
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>CIDR</th>
                                <th>Groups</th>
                                <th>Description</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .networks}}
                            <tr>
                                <td>
                                    <i class="bi bi-diagram-2 me-2 text-success"></i>
                                    <strong>{{.Name}}</strong>
                                </td>
                                <td><code>{{.CIDR}}</code></td>
                                <td>
                                    <span class="group-badges" data-network-id="{{.ID}}">
                                        <span class="text-muted"><small>Loading...</small></span>
                                    </span>
                                </td>
                                <td>
                                    {{if .Description}}
                                    {{.Description}}
                                    {{else}}
                                    <span class="text-muted">No description</span>
                                    {{end}}
                                </td>
                                <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="viewNetwork('{{.ID}}')" title="View">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editNetwork('{{.ID}}')" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="confirmDeleteNetwork('{{.ID}}', '{{.Name}}')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No networks found
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- View Network Modal -->
    <div class="modal fade" id="viewNetworkModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-hdd-network me-2"></i>Network Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewNetworkContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" id="viewToEditBtn" onclick="viewToEdit()">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Network Modal -->
    <div class="modal fade" id="createNetworkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Create New Network</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="createNetworkForm" onsubmit="createNetwork(event)">
                    <div class="modal-body">
                        <div id="createNetworkAlert" class="alert d-none"></div>
                        <div class="mb-3">
                            <label for="createName" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="createName" required maxlength="100" placeholder="e.g., Corporate LAN">
                        </div>
                        <div class="mb-3">
                            <label for="createCIDR" class="form-label">CIDR <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="createCIDR" required maxlength="50" placeholder="e.g., 192.168.1.0/24">
                            <small class="text-muted">Network address in CIDR notation (e.g., 10.0.0.0/8, 192.168.1.0/24)</small>
                        </div>
                        <div class="mb-3">
                            <label for="createDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="createDescription" rows="3" maxlength="500"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Create Network
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Network Modal -->
    <div class="modal fade" id="editNetworkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Network</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editNetworkForm" onsubmit="updateNetwork(event)">
                    <input type="hidden" id="editNetworkId">
                    <div class="modal-body">
                        <div id="editNetworkAlert" class="alert d-none"></div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editName" required maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="editCIDR" class="form-label">CIDR <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editCIDR" required maxlength="50">
                            <small class="text-muted">Network address in CIDR notation (e.g., 10.0.0.0/8, 192.168.1.0/24)</small>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3" maxlength="500"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-check-lg me-1"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteNetworkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete network <strong id="deleteNetworkName"></strong>?</p>
                    <p class="text-danger mb-0"><small>This action cannot be undone. Groups assigned to this network will lose access.</small></p>
                    <input type="hidden" id="deleteNetworkId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteNetwork()">
                        <i class="bi bi-trash me-1"></i>Delete Network
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        let currentViewNetworkId = null;

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // Load groups for each network on page load
        async function loadNetworkGroups() {
            const badges = document.querySelectorAll('.group-badges');
            for (const badge of badges) {
                const networkId = badge.dataset.networkId;
                try {
                    const response = await fetch(`/api/v1/networks/${networkId}/groups`);
                    if (response.ok) {
                        const groups = await response.json();
                        if (groups && groups.length > 0) {
                            badge.innerHTML = groups.map(g =>
                                `<span class="badge bg-primary me-1"><i class="bi bi-folder me-1"></i>${g.name}</span>`
                            ).join('');
                        } else {
                            badge.innerHTML = '<span class="text-muted"><small>No groups</small></span>';
                        }
                    }
                } catch (error) {
                    badge.innerHTML = '<span class="text-danger"><small>Error</small></span>';
                }
            }
        }

        // View Network
        async function viewNetwork(id) {
            currentViewNetworkId = id;
            const modal = new bootstrap.Modal(document.getElementById('viewNetworkModal'));
            modal.show();

            document.getElementById('viewNetworkContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

            try {
                const [networkResponse, groupsResponse] = await Promise.all([
                    fetch(`/api/v1/networks/${id}`),
                    fetch(`/api/v1/networks/${id}/groups`)
                ]);

                if (!networkResponse.ok) throw new Error('Failed to load network');
                const network = await networkResponse.json();
                const groups = groupsResponse.ok ? await groupsResponse.json() : [];

                renderNetworkDetail(network, groups);
            } catch (error) {
                document.getElementById('viewNetworkContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>${error.message}
                    </div>
                `;
            }
        }

        function renderNetworkDetail(network, groups) {
            const groupsHtml = groups && groups.length > 0
                ? groups.map(g => `<span class="badge bg-primary me-1"><i class="bi bi-folder me-1"></i>${g.name}</span>`).join('')
                : '<span class="text-muted">No groups assigned</span>';

            document.getElementById('viewNetworkContent').innerHTML = `
                <div class="row">
                    <div class="col-md-5 text-center border-end">
                        <div class="fs-1 text-success mb-3">
                            <i class="bi bi-diagram-2"></i>
                        </div>
                        <h4>${network.name}</h4>
                        <code class="fs-5">${network.cidr}</code>
                        <p class="text-muted mt-2">${network.description || 'No description'}</p>
                    </div>
                    <div class="col-md-7">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th width="35%"><i class="bi bi-hash me-2"></i>ID:</th>
                                <td><code class="small">${network.id}</code></td>
                            </tr>
                            <tr>
                                <th><i class="bi bi-clock me-2"></i>Created:</th>
                                <td>${new Date(network.created_at).toLocaleString()}</td>
                            </tr>
                            ${network.updated_at ? `
                            <tr>
                                <th><i class="bi bi-clock-history me-2"></i>Updated:</th>
                                <td>${new Date(network.updated_at).toLocaleString()}</td>
                            </tr>` : ''}
                        </table>
                        <hr>
                        <h6><i class="bi bi-folder me-2"></i>Groups with Access</h6>
                        <div class="mt-2">
                            ${groupsHtml}
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            Group assignments are managed from the Groups page
                        </small>
                    </div>
                </div>
            `;
        }

        function viewToEdit() {
            if (currentViewNetworkId) {
                bootstrap.Modal.getInstance(document.getElementById('viewNetworkModal')).hide();
                editNetwork(currentViewNetworkId);
            }
        }

        // Edit Network
        async function editNetwork(id) {
            const modal = new bootstrap.Modal(document.getElementById('editNetworkModal'));
            document.getElementById('editNetworkAlert').classList.add('d-none');

            try {
                const response = await fetch(`/api/v1/networks/${id}`);
                if (!response.ok) throw new Error('Failed to load network');
                const network = await response.json();

                document.getElementById('editNetworkId').value = network.id;
                document.getElementById('editName').value = network.name;
                document.getElementById('editCIDR').value = network.cidr;
                document.getElementById('editDescription').value = network.description || '';

                modal.show();
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        async function updateNetwork(event) {
            event.preventDefault();
            const alertEl = document.getElementById('editNetworkAlert');
            alertEl.classList.add('d-none');

            const id = document.getElementById('editNetworkId').value;
            const data = {
                name: document.getElementById('editName').value,
                cidr: document.getElementById('editCIDR').value,
                description: document.getElementById('editDescription').value || null
            };

            try {
                const response = await fetch(`/api/v1/networks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editNetworkModal')).hide();
                    showAlert('Network updated successfully');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const error = await response.json();
                    alertEl.className = 'alert alert-danger';
                    alertEl.textContent = error.message || 'Failed to update network';
                    alertEl.classList.remove('d-none');
                }
            } catch (error) {
                alertEl.className = 'alert alert-danger';
                alertEl.textContent = 'Connection error';
                alertEl.classList.remove('d-none');
            }
        }

        // Create Network
        async function createNetwork(event) {
            event.preventDefault();
            const alertEl = document.getElementById('createNetworkAlert');
            alertEl.classList.add('d-none');

            const data = {
                name: document.getElementById('createName').value,
                cidr: document.getElementById('createCIDR').value,
                description: document.getElementById('createDescription').value || null
            };

            try {
                const response = await fetch('/api/v1/networks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createNetworkModal')).hide();
                    showAlert('Network created successfully');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const error = await response.json();
                    alertEl.className = 'alert alert-danger';
                    alertEl.textContent = error.message || 'Failed to create network';
                    alertEl.classList.remove('d-none');
                }
            } catch (error) {
                alertEl.className = 'alert alert-danger';
                alertEl.textContent = 'Connection error';
                alertEl.classList.remove('d-none');
            }
        }

        // Delete Network
        function confirmDeleteNetwork(id, name) {
            document.getElementById('deleteNetworkId').value = id;
            document.getElementById('deleteNetworkName').textContent = name;
            new bootstrap.Modal(document.getElementById('deleteNetworkModal')).show();
        }

        async function deleteNetwork() {
            const id = document.getElementById('deleteNetworkId').value;

            try {
                const response = await fetch(`/api/v1/networks/${id}`, { method: 'DELETE' });

                bootstrap.Modal.getInstance(document.getElementById('deleteNetworkModal')).hide();

                if (response.ok) {
                    showAlert('Network deleted successfully');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to delete network', 'danger');
                }
            } catch (error) {
                showAlert('Connection error', 'danger');
            }
        }

        // Load groups on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadNetworkGroups();
        });
    </script>
</body>
</html>
